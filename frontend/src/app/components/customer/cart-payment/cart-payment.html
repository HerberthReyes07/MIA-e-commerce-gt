<div class="container">
	<div class="page-header">
		<h1 class="page-title">
			<mat-icon>payment</mat-icon>
			Proceso de Pago
		</h1>
		<button mat-button (click)="goBackToCart()">
			<mat-icon>arrow_back</mat-icon>
			Volver al carrito
		</button>
	</div>

	<mat-stepper [linear]="true" #stepper class="payment-stepper">

		<!-- Paso 1: Revisar productos -->
		<mat-step [completed]="cartItems.length > 0">
			<ng-template matStepLabel>Revisar productos</ng-template>

			<div class="step-content">
				@if (isLoadingCart) {
				<div class="loading-message">
					<mat-icon>hourglass_empty</mat-icon>
					<p>Cargando productos...</p>
				</div>
				} @else if (cartItems.length === 0) {
				<div class="empty-message">
					<mat-icon>shopping_cart</mat-icon>
					<p>No hay productos en el carrito</p>
					<button mat-raised-button color="primary" (click)="goBackToCart()">
						Volver al carrito
					</button>
				</div>
				} @else {
				<div class="products-review">
					<h3>Productos a comprar ({{ cartItems.length }})</h3>

					<div class="products-list">
						@for (item of cartItems; track item.cartItemId) {
						<mat-card class="product-item">
							<div class="product-content">
								<div class="product-image">
									@if (getImageUrl(item.productImageUrl)) {
									<img [src]="getImageUrl(item.productImageUrl)" [alt]="item.productName" />
									} @else {
									<div class="no-image">
										<mat-icon>image_not_supported</mat-icon>
									</div>
									}
								</div>
								<div class="product-info">
									<div class="product-name">{{ item.productName }}</div>
									<div class="product-details">
										<span class="product-price">Q {{ item.productPrice | number:'1.2-2' }}</span>
										<span class="product-quantity">x {{ item.quantity }}</span>
									</div>
									@if (item.productIsNew) {
									<span class="badge-new">Nuevo</span>
									} @else {
									<span class="badge-used">Usado</span>
									}
								</div>
								<div class="product-total">
									Q {{ getItemTotal(item) | number:'1.2-2' }}
								</div>
							</div>
						</mat-card>
						}
					</div>

					<mat-card class="total-card">
						<div class="total-row">
							<span class="total-label">Total a pagar:</span>
							<span class="total-amount">Q {{ getCartTotal() | number:'1.2-2' }}</span>
						</div>
					</mat-card>

					<div class="step-actions">
						<button mat-raised-button color="primary" matStepperNext>
							Continuar
							<mat-icon>arrow_forward</mat-icon>
						</button>
					</div>
				</div>
				}
			</div>
		</mat-step>

		<!-- Paso 2: Seleccionar/Ingresar tarjeta -->
		<mat-step [completed]="isStep2Valid()">
			<ng-template matStepLabel>Método de pago</ng-template>

			<div class="step-content">
				<h3>Selecciona tu método de pago</h3>

				<form [formGroup]="cardSelectionForm">
					<mat-radio-group formControlName="paymentMethod" (change)="onPaymentMethodChange($event.value)"
						class="payment-method-group">

						<!-- Opción: Tarjetas guardadas -->
						@if (savedCards.length > 0) {
						<mat-radio-button value="saved" class="payment-method-option">
							Usar tarjeta guardada
						</mat-radio-button>

						@if (selectedPaymentMethod === 'saved') {
						<div class="saved-cards-container">
							@if (isLoadingCards) {
							<div class="loading-message-small">Cargando tarjetas...</div>
							} @else {
							@for (card of savedCards; track card.id) {
							<mat-card class="saved-card" [class.selected]="selectedSavedCardId === card.id"
								(click)="selectSavedCard(card.id)">
								<div class="card-content">
									<mat-icon class="card-icon">credit_card</mat-icon>
									<div class="card-info">
										<div class="card-number">{{ maskCardNumber(card.cardNumber) }}</div>
										<div class="card-holder">{{ card.cardHolder }}</div>
										@if (card.alias) {
										<div class="card-alias">{{ card.alias }}</div>
										}
										<div class="card-expiry">Vence: {{ card.expirationDate }}</div>
									</div>
									@if (selectedSavedCardId === card.id) {
									<mat-icon class="check-icon">check_circle</mat-icon>
									}
								</div>
							</mat-card>
							}
							}
						</div>
						}
						}

						<!-- Opción: Nueva tarjeta -->
						<mat-radio-button value="new" class="payment-method-option">
							Usar nueva tarjeta
						</mat-radio-button>
					</mat-radio-group>
				</form>

				<!-- Expansion panel para nueva tarjeta -->
				@if (selectedPaymentMethod === 'new') {
				<mat-expansion-panel [expanded]="true" class="new-card-panel">
					<mat-expansion-panel-header>
						<mat-panel-title>
							<mat-icon>add_card</mat-icon>
							Ingresar datos de nueva tarjeta
						</mat-panel-title>
					</mat-expansion-panel-header>

					<form [formGroup]="newCardForm" class="new-card-form">
						<mat-form-field appearance="outline">
							<mat-label>Número de tarjeta</mat-label>
							<input matInput formControlName="cardNumber" placeholder="1234567890123456"
								maxlength="16" />
							@if (newCardForm.get('cardNumber')?.hasError('required')) {
							<mat-error>El número de tarjeta es requerido</mat-error>
							}
							@if (newCardForm.get('cardNumber')?.hasError('pattern')) {
							<mat-error>Debe ser un número de 16 dígitos</mat-error>
							}
						</mat-form-field>

						<mat-form-field appearance="outline">
							<mat-label>Nombre del titular</mat-label>
							<input matInput formControlName="cardHolder" placeholder="JUAN PEREZ" />
							@if (newCardForm.get('cardHolder')?.hasError('required')) {
							<mat-error>El nombre del titular es requerido</mat-error>
							}
						</mat-form-field>

						<div class="form-row">
							<mat-form-field appearance="outline">
								<mat-label>Fecha de vencimiento</mat-label>
								<input matInput [matDatepicker]="dp" formControlName="expirationDate">
								<mat-hint>MM/YYYY</mat-hint>
								<mat-datepicker-toggle matIconSuffix [for]="dp"></mat-datepicker-toggle>
								<mat-datepicker #dp startView="multi-year" (monthSelected)="setMonthAndYear($event, dp)"
									panelClass="month-year-picker">
								</mat-datepicker>
								@if (newCardForm.get('expirationDate')?.hasError('required')) {
								<mat-error>La fecha de vencimiento es requerida</mat-error>
								}
							</mat-form-field>

							<mat-form-field appearance="outline">
								<mat-label>CVV</mat-label>
								<input matInput formControlName="cvv" placeholder="123" maxlength="4" type="password" />
								@if (newCardForm.get('cvv')?.hasError('required')) {
								<mat-error>El CVV es requerido</mat-error>
								}
								@if (newCardForm.get('cvv')?.hasError('pattern')) {
								<mat-error>Debe ser 3 o 4 dígitos</mat-error>
								}
							</mat-form-field>
						</div>

						<mat-form-field appearance="outline">
							<mat-label>Alias (opcional)</mat-label>
							<input matInput formControlName="alias" placeholder="Mi tarjeta principal" />
						</mat-form-field>

						<mat-checkbox [(ngModel)]="saveNewCard" [ngModelOptions]="{standalone: true}">
							Guardar esta tarjeta para futuras compras
						</mat-checkbox>
					</form>
				</mat-expansion-panel>
				}

				<div class="step-actions">
					<button mat-button matStepperPrevious>
						<mat-icon>arrow_back</mat-icon>
						Atrás
					</button>
					<button mat-raised-button color="primary" matStepperNext [disabled]="!isStep2Valid()">
						Continuar
						<mat-icon>arrow_forward</mat-icon>
					</button>
				</div>
			</div>
		</mat-step>

		<!-- Paso 3: Confirmar compra -->
		<mat-step>
			<ng-template matStepLabel>Confirmar compra</ng-template>

			<div class="step-content">
				<h3>Resumen de tu compra</h3>

				<mat-card class="summary-section">
					<mat-card-header>
						<mat-card-title>Productos ({{ cartItems.length }})</mat-card-title>
					</mat-card-header>
					<mat-card-content>
						@for (item of cartItems; track item.cartItemId) {
						<div class="summary-product">
							<span class="summary-product-name">{{ item.productName }} x {{ item.quantity }}</span>
							<span class="summary-product-price">Q {{ getItemTotal(item) | number:'1.2-2' }}</span>
						</div>
						}
					</mat-card-content>
				</mat-card>

				<mat-card class="summary-section">
					<mat-card-header>
						<mat-card-title>Método de pago</mat-card-title>
					</mat-card-header>
					<mat-card-content>
						@if (selectedPaymentMethod === 'saved' && selectedSavedCardId) {
						@for (card of savedCards; track card.id) {
						@if (card.id === selectedSavedCardId) {
						<div class="summary-payment">
							<mat-icon>credit_card</mat-icon>
							<div>
								<div>{{ maskCardNumber(card.cardNumber) }}</div>
								<div class="payment-detail">{{ card.cardHolder }}</div>
							</div>
						</div>
						}
						}
						} @else {
						<div class="summary-payment">
							<mat-icon>add_card</mat-icon>
							<div>
								<div>Nueva tarjeta</div>
								<div class="payment-detail">{{ newCardForm.get('cardHolder')?.value }}</div>
								<div class="payment-detail">Vence: {{
									formatExpirationDate(newCardForm.get('expirationDate')?.value) }}</div>
								@if (saveNewCard) {
								<div class="payment-note">Se guardará esta tarjeta</div>
								}
							</div>
						</div>
						}
					</mat-card-content>
				</mat-card>

				<mat-card class="summary-total">
					<div class="total-final">
						<span class="total-final-label">Total a pagar:</span>
						<span class="total-final-amount">Q {{ getCartTotal() | number:'1.2-2' }}</span>
					</div>
				</mat-card>

				<div class="step-actions">
					<button mat-button matStepperPrevious>
						<mat-icon>arrow_back</mat-icon>
						Atrás
					</button>
					<button mat-raised-button color="primary" (click)="processPayment()" class="pay-button">
						<mat-icon>lock</mat-icon>
						Pagar ahora
					</button>
				</div>
			</div>
		</mat-step>

	</mat-stepper>
</div>